<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
<!-- OneTrust Cookies Consent Notice start for xilinx.github.io -->

<script src="https://cdn.cookielaw.org/scripttemplates/otSDKStub.js" data-document-language="true" type="text/javascript" charset="UTF-8" data-domain-script="03af8d57-0a04-47a6-8f10-322fa00d8fc7" ></script>
<script type="text/javascript">
function OptanonWrapper() { }
</script>
<!-- OneTrust Cookies Consent Notice end for xilinx.github.io -->
<!-- Google Tag Manager -->
<script type="text/plain" class="optanon-category-C0002">(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
'//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-5RHQV7');</script>
<!-- End Google Tag Manager -->
  <title>Managing Video Acceleration Compute Resources &mdash; Xilinx Video SDK 1.5 (Production) documentation</title>
      <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="_static/_static/custom.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/doctools.js"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Deploying with Kubernetes" href="deploying_with_kubernetes.html" />
    <link rel="prev" title="Using FFmpeg" href="using_ffmpeg.html" /> 
</head>

<body class="wy-body-for-nav">

<!-- Google Tag Manager -->
<noscript><iframe src="//www.googletagmanager.com/ns.html?id=GTM-5RHQV7" height="0" width="0" style="display:none;visibility:hidden" class="optanon-category-C0002"></iframe></noscript>
<!-- End Google Tag Manager --> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
            <a href="index.html" class="icon icon-home"> Xilinx Video SDK
            <img src="_static/xilinx-header-logo.svg" class="logo" alt="Logo"/>
          </a>
              <div class="version">
                1.5
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Get Started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="release_notes.html">Release Notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="getting_started_on_prem.html">On Premises</a></li>
<li class="toctree-l1"><a class="reference internal" href="getting_started_on_vt1.html">Amazon EC2 VT1</a></li>
<li class="toctree-l1"><a class="reference internal" href="container_setup.html">Container Setup</a></li>
<li class="toctree-l1"><a class="reference internal" href="examples.html">Tutorials and Examples</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Reference Guides</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="specs_and_features.html">Specs and Features</a></li>
<li class="toctree-l1"><a class="reference internal" href="using_ffmpeg.html">Using FFmpeg</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Managing Compute Resources</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#introduction">Introduction</a></li>
<li class="toctree-l2"><a class="reference internal" href="#using-explicit-device-ids">Using Explicit Device IDs</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#examples-using-explicit-device-ids">Examples using Explicit Device IDs</a></li>
<li class="toctree-l3"><a class="reference internal" href="#managing-resource-utilization">Managing Resource Utilization</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#using-job-descriptions">Using Job Descriptions</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#video-transcode-job-description">Video Transcode Job Description</a></li>
<li class="toctree-l3"><a class="reference internal" href="#using-job-slot-reservations">Using Job Slot Reservations</a></li>
<li class="toctree-l3"><a class="reference internal" href="#the-ffmpeg-launcher-example">The FFmpeg Launcher Example</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#xrm-reference-guide">XRM Reference Guide</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#command-line-interface">Command Line Interface</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#setup">Setup</a></li>
<li class="toctree-l4"><a class="reference internal" href="#generating-status-reports">Generating Status Reports</a></li>
<li class="toctree-l4"><a class="reference internal" href="#loading-unloading-hardware-accelerators">Loading/Unloading Hardware Accelerators</a></li>
<li class="toctree-l4"><a class="reference internal" href="#loading-unloading-software-plugins">Loading/Unloading Software Plugins</a></li>
<li class="toctree-l4"><a class="reference internal" href="#controlling-the-xrmd-daemon">Controlling the xrmd Daemon</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#c-application-programming-interface">C Application Programming Interface</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="deploying_with_kubernetes.html">Deploying with Kubernetes</a></li>
<li class="toctree-l1"><a class="reference internal" href="c_apis.html">C API Programming Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="card_management.html">Card Management</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Support</span></p>
<ul>
<li class="toctree-l1"><a class="reference external" href="https://github.com/Xilinx/video-sdk/issues">File an issue</a></li>
<li class="toctree-l1"><a class="reference internal" href="contributing.html">Contributing</a></li>
<li class="toctree-l1"><a class="reference external" href="https://xilinx.github.io/video-sdk/browse.html">Other versions</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu"  style="background: black" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">Xilinx Video SDK</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home"></a> &raquo;</li>
      <li>Managing Video Acceleration Compute Resources</li>
      <li class="wy-breadcrumbs-aside">
            <a href="_sources/managing_compute_resources.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="managing-video-acceleration-compute-resources">
<h1>Managing Video Acceleration Compute Resources<a class="headerlink" href="#managing-video-acceleration-compute-resources" title="Permalink to this headline">¶</a></h1>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>This page describes how to manage video acceleration resources and run multiple jobs on given machine through the Xilinx Resource Manager (XRM). For information about managing multiple tasks across a cluster of machines using orchestration services (i.e Kubernetes or EKS), refer to the following page: <a class="reference internal" href="deploying_with_kubernetes.html#deploying-with-kubernetes"><span class="std std-ref">Deploying with Kubernetes</span></a>.</p>
</div>
<div class="contents local topic" id="table-of-contents">
<p class="topic-title">Table of Contents</p>
<ul class="simple">
<li><p><a class="reference internal" href="#introduction" id="id4">Introduction</a></p></li>
<li><p><a class="reference internal" href="#using-explicit-device-ids" id="id5">Using Explicit Device IDs</a></p></li>
<li><p><a class="reference internal" href="#using-job-descriptions" id="id6">Using Job Descriptions</a></p></li>
<li><p><a class="reference internal" href="#xrm-reference-guide" id="id7">XRM Reference Guide</a></p></li>
</ul>
</div>
<section id="introduction">
<h2><a class="toc-backref" href="#id4">Introduction</a><a class="headerlink" href="#introduction" title="Permalink to this headline">¶</a></h2>
<p>Each Xilinx device on an Alveo U30 card can process an aggregate load of 4K pixels at 60 frames per second. The Xilinx Video SDK supports running multiple jobs simultaenously on a given device if the overall throughput does not exceed the limit of 4kp60. When the user has access to more than one device on a given machine, the Xilinx Video SDK also supports running multiple jobs across multiple devices. In this situation, it becomes important to manage the pool of video acceleration resources in order to get the most out of the total compute bandwidth available in the system.</p>
<p>The Xilinx Video SDK provides two distinct methods of managing resources and mapping transcoding jobs to Xilinx devices:</p>
<ol class="arabic simple">
<li><p><a class="reference internal" href="#using-explicit-device-ids"><span class="std std-ref">Using explicit device IDs</span></a> - This is the recommended method. It is the simplest to use and will work for most use cases.</p></li>
<li><p><a class="reference internal" href="#using-job-descriptions"><span class="std std-ref">Using the job description and reservation service</span></a> - This method is considered an advanced feature. It is provided as a starting point for users who need to develop custom job management services.</p></li>
</ol>
<p>Both methods rely on the Xilinx® FPGA resource manager (XRM). XRM is a software layer responsible for managing the hardware accelerators available in the system. XRM keeps track of total system capacity for each of the compute units (i.e. decoder, scaler, encoder…), ensures capacity for a given use case and prevents over-allocation.</p>
<p class="rubric">System Considerations</p>
<ul class="simple">
<li><p>When a job ends and releases CU resources to XRM, it takes a few milliseconds before they become available for another job.</p></li>
<li><p>On certain servers, it may be needed to reduce the stack size (using <code class="docutils literal notranslate"><span class="pre">ulimit</span> <span class="pre">-s</span> <span class="pre">1000</span></code>) in order to run more than 200 processes simultaneously.</p></li>
</ul>
<div class="line-block">
<div class="line"><br /></div>
</div>
</section>
<section id="using-explicit-device-ids">
<span id="id1"></span><h2><a class="toc-backref" href="#id5">Using Explicit Device IDs</a><a class="headerlink" href="#using-explicit-device-ids" title="Permalink to this headline">¶</a></h2>
<p>The simplest way to run multiple FFmpeg jobs across all available devices is to use the <a class="reference internal" href="using_ffmpeg.html#cmdoption-xlnx_hwdev"><code class="xref std std-option docutils literal notranslate"><span class="pre">-xlnx_hwdev</span></code></a> option.</p>
<p>By default (if the option is not specified) the job will be submitted to device 0. When running multiple jobs, device 0 will likely run out resources rapidly and additional jobs will error out due to insufficient resources.</p>
<p>The <a class="reference internal" href="using_ffmpeg.html#cmdoption-xlnx_hwdev"><code class="xref std std-option docutils literal notranslate"><span class="pre">-xlnx_hwdev</span></code></a> option is used to specify the device on which the job should be run. This makes it easy and straightforward to leverage the entire video acceleration capacity of your system, regardless of the number of cards and devices. In addition, this method allows running different types of jobs on the same device (i.e.: jobs with different resolutions, frame rates, etc…).</p>
<section id="examples-using-explicit-device-ids">
<h3>Examples using Explicit Device IDs<a class="headerlink" href="#examples-using-explicit-device-ids" title="Permalink to this headline">¶</a></h3>
<p>Specific examples of how to run multiple FFmpeg processes using explicit device IDs can be found in the <a class="reference internal" href="examples/ffmpeg/tutorials.html#multiple-ffmpeg-jobs-example"><span class="std std-ref">FFmpeg Tutorials</span></a> included in this repository.</p>
</section>
<section id="managing-resource-utilization">
<h3>Managing Resource Utilization<a class="headerlink" href="#managing-resource-utilization" title="Permalink to this headline">¶</a></h3>
<p>Given that each device has a 2160p60 (4K) input and output bandwidth limit, the user is responsible for only submitting jobs which will not exceed the capacity of the specified device. The <a class="reference internal" href="card_management.html#managing-resources"><span class="std std-ref">Managing Resource Utilization</span></a> section of the Card Management guide provides information on how to estimate CU requirements and check current device load.</p>
<div class="line-block">
<div class="line"><br /></div>
</div>
</section>
</section>
<section id="using-job-descriptions">
<span id="id2"></span><h2><a class="toc-backref" href="#id6">Using Job Descriptions</a><a class="headerlink" href="#using-job-descriptions" title="Permalink to this headline">¶</a></h2>
<p>Job descriptions and the associated job reservation system are an alternate way to manage resources and run multiple jobs across one or more devices. This method is more involved than using explicit device IDs, and it is intended for users who need to develop custom job management applications.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>A current limitation of this method is that only one job description file can be used at a time, and a job description file can only contain a single job description. The system will only manage multiple jobs if they match the same description. Simultaneously managing different job types is not supported currently. The jobs need to be stopped before a new job description can be loaded.</p>
</div>
<section id="video-transcode-job-description">
<h3>Video Transcode Job Description<a class="headerlink" href="#video-transcode-job-description" title="Permalink to this headline">¶</a></h3>
<p>The Xilinx video transcode pipeline needs a conjunction of multiple compute units (CUs) like decoder, scaler, lookahead, and encoder, together forming a CU pool. Based on the input resolution and type of transcode, the load of CUs within a CU pool varies. This in turn determines how many instances of such a job can be run real-time in parallel on all the cards managed by XRM. If there is free capacity, XRM will send the job to an available device.</p>
<p>The video transcode job description provides information to the resource manager about what kind of transcode is intended to run on the card. With this information, XRM calculates the CU load for the specified job as well as the maximum possible number of jobs that can be run real-time in parallel.</p>
<p>A video transcode job description is specified through a JSON file and the key-value pairs specify the functions, formats, and resolutions needed.</p>
<dl class="simple">
<dt>function</dt><dd><p>Which HW resource to use (DECODER, SCALER, ENCODER)</p>
</dd>
<dt>format</dt><dd><p>Input/output format (H264, HEVC, yuv420p)</p>
</dd>
<dt>resolution</dt><dd><p>Input/output height, width, and frame-rate as a numerator / denominator fraction</p>
</dd>
<dt>job-count</dt><dd><p>Optional entry to specify the number of instances of the specified job which can run on one device.
When this entry is used, the CU load is calculated based on the specified job-count. Any channel-load value is ignored.
This option is useful to provide an accurate number of possible jobs in the case where the load calculation by XRM is optimistic. This can happen because device memory is currently not an XRM managed resource; and in the case of high-density low-resolution jobs, it is possible to run out device memory before running out of compute resources.</p>
</dd>
<dt>channel-load</dt><dd><p>Optional entry to specify a different compute load for a given function than calculated by the resource manager.
This option will be deprecated and removed in a future release. The job-count option should be used instead.</p>
</dd>
</dl>
<p>Several examples of JSON job slot descriptions can be found in the <code class="docutils literal notranslate"><span class="pre">/opt/xilinx/launcher/scripts/describe_job</span></code> folder once the Xilinx Video SDK has been installed.</p>
<p>Below is a modified version of the <code class="docutils literal notranslate"><span class="pre">/opt/xilinx/launcher/scripts/describe_job/describe_job.json</span></code> example. This JSON example describes an ABR transcode job which uses a decoder, scaler, and encoder to generate 5 output renditions. A job-count entry has been added to explicitly request 4 instances of this job per device:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>{
    &quot;request&quot;: {
        &quot;name&quot;: &quot;describe_job_h264&quot;,
        &quot;request_id&quot;: 1,
        &quot;parameters&quot;: {
            &quot;name&quot;: &quot;testjob&quot;,
            &quot;job-count&quot;: 4,
            &quot;resources&quot;:
            [
                {
                    &quot;function&quot;: &quot;DECODER&quot;,
                    &quot;format&quot;:   &quot;H264&quot;,
                    &quot;resolution&quot;: { &quot;input&quot;: { &quot;width&quot;: 1920, &quot;height&quot;: 1080, &quot;frame-rate&quot;: { &quot;num&quot;:60, &quot;den&quot;:1} } }
                },
                {
                    &quot;function&quot;: &quot;SCALER&quot;,
                    &quot;format&quot;:   &quot;yuv420p&quot;,
                    &quot;resolution&quot;:
                    {
                        &quot;input&quot;: { &quot;width&quot;: 1920, &quot;height&quot;: 1080, &quot;frame-rate&quot;: { &quot;num&quot;:60, &quot;den&quot;:1} },
                        &quot;output&quot;:
                        [
                            { &quot;width&quot;: 1280, &quot;height&quot;: 720, &quot;frame-rate&quot;: { &quot;num&quot;:60, &quot;den&quot;:1} },
                            { &quot;width&quot;:  848, &quot;height&quot;: 480, &quot;frame-rate&quot;: { &quot;num&quot;:60, &quot;den&quot;:1} },
                            { &quot;width&quot;:  640, &quot;height&quot;: 360, &quot;frame-rate&quot;: { &quot;num&quot;:60, &quot;den&quot;:1} },
                            { &quot;width&quot;:  288, &quot;height&quot;: 160, &quot;frame-rate&quot;: { &quot;num&quot;:60, &quot;den&quot;:1} }
                        ]
                    }
                },
                {
                    &quot;function&quot;: &quot;ENCODER&quot;,
                    &quot;format&quot;:   &quot;H264&quot;,
                    &quot;resolution&quot;: { &quot;input&quot;: { &quot;width&quot;: 1280, &quot;height&quot;: 720, &quot;frame-rate&quot;: { &quot;num&quot;:60, &quot;den&quot;:1} } }
                },
                {
                    &quot;function&quot;: &quot;ENCODER&quot;,
                    &quot;format&quot;:   &quot;H264&quot;,
                    &quot;resolution&quot;: { &quot;input&quot;: { &quot;width&quot;: 1280, &quot;height&quot;: 720, &quot;frame-rate&quot;: { &quot;num&quot;:30, &quot;den&quot;:1} } }
                },
                {
                    &quot;function&quot;: &quot;ENCODER&quot;,
                    &quot;format&quot;:   &quot;H264&quot;,
                    &quot;resolution&quot;: { &quot;input&quot;: { &quot;width&quot;:  848, &quot;height&quot;: 480, &quot;frame-rate&quot;: { &quot;num&quot;:30, &quot;den&quot;:1} } }
                },
                {
                    &quot;function&quot;: &quot;ENCODER&quot;,
                    &quot;format&quot;:   &quot;H264&quot;,
                    &quot;resolution&quot;: { &quot;input&quot;: { &quot;width&quot;:  640, &quot;height&quot;: 360, &quot;frame-rate&quot;: { &quot;num&quot;:30, &quot;den&quot;:1} } }
                },
                {
                    &quot;function&quot;: &quot;ENCODER&quot;,
                    &quot;format&quot;:   &quot;H264&quot;,
                    &quot;resolution&quot;: { &quot;input&quot;: { &quot;width&quot;:  288, &quot;height&quot;: 160, &quot;frame-rate&quot;: { &quot;num&quot;:30, &quot;den&quot;:1} } }
                }
            ]
        }
    }
}
</pre></div>
</div>
<p>The next sections document the two different ways of using job descriptions to run multiple FFmpeg jobs across one or more devices:</p>
<ul class="simple">
<li><p><a class="reference internal" href="#using-job-slot-reservations"><span class="std std-ref">Using the job slot reservation application</span></a></p></li>
<li><p><a class="reference internal" href="#using-ffmpeg-launcher"><span class="std std-ref">The FFmpeg Launcher example</span></a></p></li>
</ul>
</section>
<section id="using-job-slot-reservations">
<span id="id3"></span><h3>Using Job Slot Reservations<a class="headerlink" href="#using-job-slot-reservations" title="Permalink to this headline">¶</a></h3>
<p>The job slot reservation application takes as input a video transcode job reservation in the form of a JSON file as described in the previous section. The video transcode job description provides information to the resource manager about what kind of transcode is intended to run on the card. With this information the resource manager calculates the CU load for the specified job as well as the maximum possible number of jobs that can be run real-time in parallel.</p>
<p>Once the maximum possible number of jobs is known, CUs and job slots are reserved, and corresponding reservation IDs are stored in a bash file at <code class="docutils literal notranslate"><span class="pre">/var/tmp/xilinx/xrm_jobReservation.sh</span></code>. A reservation ID is a unique identifier which is valid while the job slot reservation application is running. These reservation IDs are passed to individual FFmpeg process via an environment variable XRM_RESERVE_ID. The FFmpeg processes then use this reservation ID to retrieve the corresponding CUs reserved earlier.</p>
<p>The reserved resourced are released by ending the job reservation process. Reserved slots can be reused after an FFmpeg job finishes as long as the job reservation process is still running.</p>
<p>The <a class="reference external" href="https://github.com/Xilinx/app-jobslot-reservation-xrm/blob/v1.0.0/jobSlot_reservation.cpp">source code of the job slot reservation application</a> is included in the Github repository of Xilinx Video SDK and can be used as a starting point for developing custom orchestration layers.</p>
<p>The following steps show how to use the job slot reservation to dispatch multiple parallel instances of an ABR ladder job:</p>
<ol class="arabic">
<li><p>Setup the environment:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>source /opt/xilinx/xcdr/setup.sh
</pre></div>
</div>
</li>
<li><p>Run the job slot reservation application with the desired JSON job description. For example:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>jobSlotReservation /opt/xilinx/launcher/scripts/describe_job/describe_job.json

For describe_job.json, the possible number of job slots available = 8
--------------------------------------------------------------------------------------
The Job_slot_reservations are alive as long as this application is alive!
(press Enter to end)
--------------------------------------------------------------------------------------
</pre></div>
</div>
<p>The job slot reservation application creates a <code class="docutils literal notranslate"><span class="pre">/var/tmp/xilinx/xrm_jobReservation.sh</span></code> with XRM_RESERVE_ID_n set to unique IDs generated by XRM (with n ranging from 1 to the number of possible job slots for the given job). Here is an example of this generated file:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>source /opt/xilinx/xrt/setup.sh
source /opt/xilinx/xrm/setup.sh
export XRM_RESERVE_ID_1=9
export XRM_RESERVE_ID_2=10
export XRM_RESERVE_ID_3=11
export XRM_RESERVE_ID_4=12
export XRM_RESERVE_ID_5=13
export XRM_RESERVE_ID_6=14
export XRM_RESERVE_ID_7=15
export XRM_RESERVE_ID_8=16
</pre></div>
</div>
</li>
<li><p>Launch individual FFmpeg processes in distinct shells after sourcing the <code class="docutils literal notranslate"><span class="pre">/var/tmp/xilinx/xrm_jobReservation.sh</span></code> file and setting XRM_RESERVE_ID environment to a unique XRM_RESERVE_ID_n.</p>
<p>For job 1:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>source /var/tmp/xilinx/xrm_jobReservation.sh
export XRM_RESERVE_ID=${XRM_RESERVE_ID_1}
ffmpeg -c:v mpsoc_vcu_h264 ...
</pre></div>
</div>
<p>For job 2:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>source /var/tmp/xilinx/xrm_jobReservation.sh
export XRM_RESERVE_ID=${XRM_RESERVE_ID_2}
ffmpeg -c:v mpsoc_vcu_h264 ...
</pre></div>
</div>
<p>And so forth for the other jobs.</p>
</li>
<li><p>Press <strong>Enter</strong> in the job reservation app terminal to release the resources after the jobs are complete.</p></li>
</ol>
<p class="rubric">Ill-formed JSON Job Descriptions</p>
<p>If you run the jobSlotReservation tool with a syntactically incorrect JSON description, you will see the following messages:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>decoder plugin function=0 fail to run the function
scaler plugin function=0 fail to run the function
encoder plugin function=0 fail to run the function
</pre></div>
</div>
<p>This indicates that the job description is ill-formed and needs to be corrected.</p>
</section>
<section id="the-ffmpeg-launcher-example">
<span id="using-ffmpeg-launcher"></span><h3>The FFmpeg Launcher Example<a class="headerlink" href="#the-ffmpeg-launcher-example" title="Permalink to this headline">¶</a></h3>
<p>The FFmpeg launcher is an example application which automates the dispatching of FFmpeg jobs across multiple devices. It simplifies the process of manually setting up XRM reservation IDs and launching FFmpeg for many video streams. The FFmpeg launcher takes a transcode job description, input source files, corresponding FFmpeg run commands and automatically launches child FFmpeg processes based on the job slot availability on the server. In case there are more input streams listed than available job slots, the excess are queued and launched when a job slot becomes available. Note that only a single launcher per server is supported.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The FFmpeg launcher is only an example application. It is provided as an illustration of how an orchestration layer can use Job Descriptions, but it is not an official feature of the Xilinx Video SDK.</p>
</div>
<p>The following steps show how to use the FFmpeg launcher for an ABR transcode use case with the Xilinx Video SDK. In this use case, one encoded stream is transcoded to five unique renditions based on resolution, bit rate, and other variations.</p>
<ol class="arabic">
<li><p>Environment setup</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>source /opt/xilinx/xcdr/setup.sh
</pre></div>
</div>
</li>
<li><p>To run the FFmpeg launcher, use the following command:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>launcher &lt;source files file name&gt; &lt;run params file name&gt;
</pre></div>
</div>
<p>Here is an example of the command:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>launcher sources.txt /opt/xilinx/launcher/scripts/run_params/Run_ABR_h264_lowLatencyTranscode_mr_null.txt
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">sources.txt</span></code> is a text file that lists the input stream names. The launcher parses this list and inserts the sources in the FFmpeg command after <code class="docutils literal notranslate"><span class="pre">-i</span></code> one after another and launches them as a separate process. A sample <code class="docutils literal notranslate"><span class="pre">sources.txt</span></code> is as follows.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span># List all sources here
Input1.mp4
Video.flv
Input2.h264
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">run_params.txt</span></code> is a text file that consists of two fields. The first field is the video transcode job description, and the second field is the FFmpeg command line that needs to be launched and is matching the described job. Description of the job is given through a json file as described already in the previous sections. A sample <code class="docutils literal notranslate"><span class="pre">run_params.txt</span></code> is as follows.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>job_description = /opt/xilinx/launcher/scripts/describe_job/describe_job.json
cmdline = ffmpeg -c:v mpsoc_vcu_h264 -i -filter_complex &quot;multiscale_xma=:outputs=4:out_1_width=1280:out_1_height=720:out_1_pix_fm t=vcu_nv12:out_2_width=848:out_2_height=480:out_2_pix_fmt=vcu_nv12:out_3_ width=640:out_3_height=360:out_3_pix_fmt=vcu_nv12:out_4_width=288:out_4_h eight=160:out_4_pix_fmt=vcu_nv12 [a][b][c][d]; [a]split[aa][ab]&quot; -map &#39;[aa]&#39; -b:v 4M -max-bitrate 4M -c:v mpsoc_vcu_h264 -f h264 -y out_720p60.264 -map &#39;[ab]&#39; -r 30 -b:v 3M -max-bitrate 3M -c:v mpsoc_vcu_h264 -f h264 -y out_720p30.264 -map &#39;[b]&#39; -r 30 -b:v 2500K - max-bitrate 2500K -c:v mpsoc_vcu_h264 -f h264 -y out_480p30.264 -map &#39;[c]&#39; -r 30 -b:v 1250K -max-bitrate 1250K -c:v mpsoc_vcu_h264 -f h264 -y out_360p30.264 -map &#39;[d]&#39; -r 30 -b:v 625K -max-bitrate 625K -c:v mpsoc_vcu_h264 -f h264 -y out_160p30.264
</pre></div>
</div>
</li>
</ol>
<div class="line-block">
<div class="line"><br /></div>
</div>
</section>
</section>
<section id="xrm-reference-guide">
<span id="xrmadm-and-xrmd-commands"></span><span id="xrm-reference"></span><h2><a class="toc-backref" href="#id7">XRM Reference Guide</a><a class="headerlink" href="#xrm-reference-guide" title="Permalink to this headline">¶</a></h2>
<p>The Xilinx® FPGA resource manager (XRM) is the software which manages the hardware accelerators available in the system. XRM includes the following components:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">xrmd</span></code>: the XRM daemon, a background process supporting reservation, allocation, and release of hardware acceleration resources.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">xrmadm</span></code> the command line tool is used to interact with the XRM daemon (<code class="docutils literal notranslate"><span class="pre">xrmd</span></code>).</p></li>
<li><p>a C Application Programming Interface (API)</p></li>
</ul>
<section id="command-line-interface">
<h3>Command Line Interface<a class="headerlink" href="#command-line-interface" title="Permalink to this headline">¶</a></h3>
<p>The XRM <code class="docutils literal notranslate"><span class="pre">xrmadm</span></code> command line tool is used to interact with the XRM daemon (<code class="docutils literal notranslate"><span class="pre">xrmd</span></code>). It provides the following capabilities and uses a JSON file as input for each action:</p>
<ul class="simple">
<li><p>Generate status reports for each device</p></li>
<li><p>Load and unload the hardware accelerators</p></li>
<li><p>Load and unload the software plugins</p></li>
</ul>
<p>The XRM related files are installed under <code class="docutils literal notranslate"><span class="pre">/opt/xilinx/xrm/</span></code> and device-specific XRM commands are available at <code class="docutils literal notranslate"><span class="pre">/opt/xilinx/xcdr/scripts/xrm_commands/</span></code>.</p>
<section id="setup">
<h4>Setup<a class="headerlink" href="#setup" title="Permalink to this headline">¶</a></h4>
<p>When sourced, the <code class="docutils literal notranslate"><span class="pre">/opt/xilinx/xcdr/setup.sh</span></code> script takes care of setting up the enviroment for the Xilinx Video SDK, including its XRM components:</p>
<ul class="simple">
<li><p>The XRM daemon (<code class="docutils literal notranslate"><span class="pre">xrmd</span></code>) is started</p></li>
<li><p>The hardware accelerators (xclbin) and software plugins are loaded on the Xilinx devices</p></li>
</ul>
</section>
<section id="generating-status-reports">
<h4>Generating Status Reports<a class="headerlink" href="#generating-status-reports" title="Permalink to this headline">¶</a></h4>
<p><code class="docutils literal notranslate"><span class="pre">xrmadm</span></code> can generate reports with the status of each device in the system. This capability is particularly useful to check the loading of each hardware accelerator.</p>
<p>To generate a report for all the devices in the system:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>xrmadm /opt/xilinx/xrm/test/list_cmd.json
</pre></div>
</div>
<p>To generate a report for a single device specified in the json file:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>xrmadm /opt/xilinx/xrm/test/list_onedevice.json
</pre></div>
</div>
<p>A sample JSON file for generating a report for device 0 is shown below:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>{
    &quot;request&quot;: {
        &quot;name&quot;: &quot;list&quot;,
        &quot;requestId&quot;: 1,
        &quot;device&quot;: 0
    }
}
</pre></div>
</div>
</section>
<section id="loading-unloading-hardware-accelerators">
<h4>Loading/Unloading Hardware Accelerators<a class="headerlink" href="#loading-unloading-hardware-accelerators" title="Permalink to this headline">¶</a></h4>
<p><code class="docutils literal notranslate"><span class="pre">xrmadm</span></code> can be used to load or unload the hardware accelerators on the programmable devices of the Alveo U30 card. The hardware accelerators must be reloaded after rebooting a card.</p>
<p>To load the hardware accelerators on a given device:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>xrmadm /opt/xilinx/xcdr/scripts/xrm_commands/load_multiple_devices/load_device0_cmd.json
</pre></div>
</div>
<p>To unload the hardware accelerators from a given device:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>xrmadm /opt/xilinx/xcdr/scripts/xrm_commands/unload_multiple_devices/unload_device_0_cmd.json
</pre></div>
</div>
<p>A sample JSON file for loading two devices (0 and 1) is shown below:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>{
    &quot;request&quot;: {
        &quot;name&quot;: &quot;load&quot;,
        &quot;requestId&quot;: 1,
        &quot;parameters&quot;: [
            {
            &quot;device&quot;: 0,
            &quot;xclbin&quot;: &quot;/opt/xilinx/xcdr/xclbins/transcode.xclbin&quot;
            },
            {
            &quot;device&quot;: 1,
            &quot;xclbin&quot;: &quot;/opt/xilinx/xcdr/xclbins/transcode.xclbin&quot;
            }
        ]
    }
}
</pre></div>
</div>
</section>
<section id="loading-unloading-software-plugins">
<h4>Loading/Unloading Software Plugins<a class="headerlink" href="#loading-unloading-software-plugins" title="Permalink to this headline">¶</a></h4>
<p><code class="docutils literal notranslate"><span class="pre">xrmadm</span></code> can be used to load or unload the software plugins required to manage the compute resources. The software plugins perform resource management functions such as calculating CU load and CU max capacity. Once a plugin is loaded, it becomes usable by a host application through the XRM APIs. The XRM plugins need to be loaded before executing an application (such as FFmpeg) which relies on the plugins.</p>
<p>To load the plugins:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>xrmadm /opt/xilinx/xcdr/scripts/xrm_commands/load_multi_u30_xrm_plugins_cmd.json
</pre></div>
</div>
<p>To unload the plugins:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>xrmadm /opt/xilinx/xcdr/scripts/xrm_commands/unload_multi_u30_xrm_plugins_cmd.json
</pre></div>
</div>
</section>
<section id="controlling-the-xrmd-daemon">
<h4>Controlling the xrmd Daemon<a class="headerlink" href="#controlling-the-xrmd-daemon" title="Permalink to this headline">¶</a></h4>
<p>The following commands can be used to start, stop, restart, or get the status of the daemon:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>sudo /opt/xilinx/xrm/tools/start_xrmd.sh
sudo /opt/xilinx/xrm/tools/stop_xrmd.sh
sudo /opt/xilinx/xrm/tools/restart_xrmd.sh
sudo systemctl status xrmd
</pre></div>
</div>
</section>
</section>
<section id="c-application-programming-interface">
<h3>C Application Programming Interface<a class="headerlink" href="#c-application-programming-interface" title="Permalink to this headline">¶</a></h3>
<p>XRM provides a C Application Programming Interface (API) to reserve, allocate and release CUs from within a custom application. For complete details about this programming interface, refer to the <a class="reference internal" href="c_apis.html#xrm-api-reference"><span class="std std-ref">XRM API Reference Guide</span></a> section of the documentation.</p>
</section>
</section>
</section>


           </div>
          </div>
          
				  
				  <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="using_ffmpeg.html" class="btn btn-neutral float-left" title="Using FFmpeg" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="deploying_with_kubernetes.html" class="btn btn-neutral float-right" title="Deploying with Kubernetes" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2020-2023, Advanced Micro Devices, Inc.
      <span class="lastupdated">Last updated on September 11, 2023.
      </span></p>
  </div>



										<div class="aem-Grid aem-Grid--16">
											<div class="aem-GridColumn aem-GridColumn--xxxlarge--none aem-GridColumn--xsmall--16 aem-GridColumn--offset--xsmall--0 aem-GridColumn--xlarge--none aem-GridColumn--xxlarge--none aem-GridColumn--default--none aem-GridColumn--offset--large--1 aem-GridColumn--xlarge--12 aem-GridColumn--offset--default--0 aem-GridColumn--xxlarge--10 aem-GridColumn--offset--xlarge--2 aem-GridColumn--offset--xxlarge--3 aem-GridColumn--offset--xxxlarge--4 aem-GridColumn--xsmall--none aem-GridColumn--large--none aem-GridColumn aem-GridColumn--large--14 aem-GridColumn--xxxlarge--8 aem-GridColumn--default--16">
												<div class="container-fluid sub-footer">

													                    <div class="row">
                        <div class="col-xs-24">
                          <p><a target="_blank" href="https://www.amd.com/en/corporate/copyright">Terms and Conditions</a> | <a target="_blank" href="https://www.amd.com/en/corporate/privacy">Privacy</a> | <a target="_blank" href="https://www.amd.com/en/corporate/cookies">Cookie Policy</a> | <a target="_blank" href="https://www.amd.com/en/corporate/trademarks">Trademarks</a> | <a target="_blank" href="https://www.amd.com/system/files/documents/statement-human-trafficking-forced-labor.pdf">Statement on Forced Labor</a> | <a target="_blank" href="https://www.amd.com/en/corporate/competition">Fair and Open Competition</a> | <a target="_blank" href="https://www.amd.com/system/files/documents/amd-uk-tax-strategy.pdf">UK Tax Strategy</a> | <a target="_blank" href="https://docs.xilinx.com/v/u/9x6YvZKuWyhJId7y7RQQKA">Inclusive Terminology</a> | <a href="#cookiessettings" class="ot-sdk-show-settings">Cookies Settings</a></p>
                        </div>
                    </div>
												</div>
											</div>
										</div>
										
</br>


  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>
 <script type="text/javascript">
    $(document).ready(function() {
        $(".toggle > *").hide();
        $(".toggle .header").show();
        $(".toggle .header").click(function() {
            $(this).parent().children().not(".header").toggle(400);
            $(this).parent().children(".header").toggleClass("open");
        })
    });
</script>


</body>
</html>