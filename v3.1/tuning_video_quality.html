<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
<!-- OneTrust Cookies Consent Notice start for xilinx.github.io -->

<script src="https://cdn.cookielaw.org/scripttemplates/otSDKStub.js" data-document-language="true" type="text/javascript" charset="UTF-8" data-domain-script="03af8d57-0a04-47a6-8f10-322fa00d8fc7" ></script>
<script type="text/javascript">
function OptanonWrapper() { }
</script>
<!-- OneTrust Cookies Consent Notice end for xilinx.github.io -->
<!-- Google Tag Manager -->
<script type="text/plain" class="optanon-category-C0002">(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
'//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-5RHQV7');</script>
<!-- End Google Tag Manager -->
  <title>Tuning Video Quality &mdash; Xilinx Video SDK 3.1 (Production) documentation</title>
      <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="_static/_static/custom.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="_static/documentation_options.js?v=d2dc9114"></script>
        <script src="_static/doctools.js?v=888ff710"></script>
        <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Tuning Transcode Latency" href="tuning_pipeline_latency.html" />
    <link rel="prev" title="Using GStreamer" href="using_gstreamer.html" /> 
</head>

<body class="wy-body-for-nav">

<!-- Google Tag Manager -->
<noscript><iframe src="//www.googletagmanager.com/ns.html?id=GTM-5RHQV7" height="0" width="0" style="display:none;visibility:hidden" class="optanon-category-C0002"></iframe></noscript>
<!-- End Google Tag Manager --> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
            <a href="index.html" class="icon icon-home"> Xilinx Video SDK
          </a>
              <div class="version">
                3.1
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Get Started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="release_notes.html">Release Notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="getting_started_on_prem.html">On Premises</a></li>
<li class="toctree-l1"><a class="reference internal" href="getting_started_on_vt1.html">Amazon EC2 VT1</a></li>
<li class="toctree-l1"><a class="reference internal" href="container_setup.html">Container Setup</a></li>
<li class="toctree-l1"><a class="reference internal" href="examples.html">Tutorials and Examples</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Reference Guides</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="specs_and_features.html">Specs and Features</a></li>
<li class="toctree-l1"><a class="reference internal" href="using_ffmpeg.html">Using FFmpeg</a></li>
<li class="toctree-l1"><a class="reference internal" href="using_gstreamer.html">Using GStreamer</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Tuning Video Quality</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#abr-scaling">ABR Scaling</a></li>
<li class="toctree-l2"><a class="reference internal" href="#number-of-b-frames">Number of B Frames</a></li>
<li class="toctree-l2"><a class="reference internal" href="#lookahead">Lookahead</a></li>
<li class="toctree-l2"><a class="reference internal" href="#adaptive-quantization">Adaptive Quantization</a></li>
<li class="toctree-l2"><a class="reference internal" href="#scaling-list">Scaling List</a></li>
<li class="toctree-l2"><a class="reference internal" href="#dynamic-encoder-parameters">Dynamic Encoder Parameters</a></li>
<li class="toctree-l2"><a class="reference internal" href="#dynamic-idr-frame-insertion">Dynamic IDR Frame Insertion</a></li>
<li class="toctree-l2"><a class="reference internal" href="#dynamic-gop">Dynamic GOP</a></li>
<li class="toctree-l2"><a class="reference internal" href="#objective-metrics-versus-subjective-quality">Objective Metrics versus Subjective Quality</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="tuning_pipeline_latency.html">Tuning Transcode Latency</a></li>
<li class="toctree-l1"><a class="reference internal" href="managing_compute_resources.html">Managing Compute Resources</a></li>
<li class="toctree-l1"><a class="reference internal" href="deploying_with_kubernetes.html">Deploying with Kubernetes</a></li>
<li class="toctree-l1"><a class="reference internal" href="c_apis.html">C API Programming Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="card_management.html">Card Management</a></li>
<li class="toctree-l1"><a class="reference internal" href="package_feed.html">Package Feed Setup</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Support</span></p>
<ul>
<li class="toctree-l1"><a class="reference external" href="https://github.com/Xilinx/video-sdk/issues">File an issue</a></li>
<li class="toctree-l1"><a class="reference internal" href="contributing.html">Contributing</a></li>
<li class="toctree-l1"><a class="reference external" href="https://xilinx.github.io/video-sdk/browse.html">Other versions</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu"  style="background: black" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">Xilinx Video SDK</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home"></a> &raquo;</li>
      <li>Tuning Video Quality</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="tuning-video-quality">
<span id="id1"></span><h1>Tuning Video Quality<a class="headerlink" href="#tuning-video-quality" title="Link to this heading">¶</a></h1>
<nav class="contents local" id="table-of-contents">
<p class="topic-title">Table of Contents</p>
<ul class="simple">
<li><p><a class="reference internal" href="#abr-scaling" id="id4">ABR Scaling</a></p></li>
<li><p><a class="reference internal" href="#number-of-b-frames" id="id5">Number of B Frames</a></p></li>
<li><p><a class="reference internal" href="#lookahead" id="id6">Lookahead</a></p></li>
<li><p><a class="reference internal" href="#adaptive-quantization" id="id7">Adaptive Quantization</a></p></li>
<li><p><a class="reference internal" href="#scaling-list" id="id8">Scaling List</a></p></li>
<li><p><a class="reference internal" href="#dynamic-encoder-parameters" id="id9">Dynamic Encoder Parameters</a></p></li>
<li><p><a class="reference internal" href="#dynamic-idr-frame-insertion" id="id10">Dynamic IDR Frame Insertion</a></p></li>
<li><p><a class="reference internal" href="#dynamic-gop" id="id11">Dynamic GOP</a></p></li>
<li><p><a class="reference internal" href="#objective-metrics-versus-subjective-quality" id="id12">Objective Metrics versus Subjective Quality</a></p></li>
</ul>
</nav>
<p>The quality of encoded video depends on various factors. It is primarily a function of the target bit rate and the type of video content. However, there are some encoder parameters which can be used to adjust the video quality. This document describes the major parameters impacting video quality. These paramaters and the underlying concepts are applicable whether using FFmpeg, GStreamer or the C XMA APIs.</p>
<p>Various examples illustrating the effect of these settings can be found here:</p>
<ul class="simple">
<li><p><a class="reference internal" href="examples/ffmpeg/quality_analysis.html"><span class="doc">FFmpeg quality analysis examples</span></a>.</p></li>
<li><p><a class="reference internal" href="examples/gstreamer/quality_analysis.html"><span class="doc">GStreamer quality analysis examples</span></a>.</p></li>
</ul>
<section id="abr-scaling">
<span id="tuning-abr-scaling"></span><h2><a class="toc-backref" href="#id4" role="doc-backlink">ABR Scaling</a><a class="headerlink" href="#abr-scaling" title="Link to this heading">¶</a></h2>
<p>The figure below illustrates a scaling ladder with a 1920x1080 input and 4 outputs with resolutions of 1280x720, 852x480, 640x360, and 416x240, respectively.</p>
<figure class="align-center" id="id3">
<img alt="output from one rung is passed to the next for further scaling" src="_images/abr_ladder.png" />
<figcaption>
<p><span class="caption-text">Scaling ladder: the output from one rung is passed to the next for further scaling</span><a class="headerlink" href="#id3" title="Link to this image">¶</a></p>
</figcaption>
</figure>
<p>For the complete list of features and capabilities of the Xilinx hardware scaler, refer to the <a class="reference internal" href="specs_and_features.html#adaptive-bitrate-scaler"><span class="std std-ref">Adaptive Bitrate Scaler features</span></a> section of the <a class="reference internal" href="specs_and_features.html"><span class="doc">Specs and Features</span></a> chapter of the documentation.</p>
<p class="rubric">Scaling Order</p>
<p>The scaler is tuned for downscaling and expects non-increasing resolutions in an ABR ladder. Increasing resolutions between outputs is supported but will reduce video quality. For best results, the outputs must be configured in descending order. The frame rate and resolution of a given output should be smaller or equal than the rate of the previous output. Since the output of one scaling stage is passed as an input to the next, video quality will be negatively affected if frame rate is increased after it has been lowered.</p>
<p class="rubric">Scaling Ratio</p>
<p>Down scale ratios greater than 3 lead to poor visual quality. To address this issue, multiple number of arms must be added to the scaler ladder, where each arm accommodates down scale ratios of up to 3. For example, to down scale from 1920x1080 to 512x288, 2 scaler arms are required in order to preserve high visual quality.</p>
</section>
<section id="number-of-b-frames">
<span id="tuning-b-frames"></span><h2><a class="toc-backref" href="#id5" role="doc-backlink">Number of B Frames</a><a class="headerlink" href="#number-of-b-frames" title="Link to this heading">¶</a></h2>
<p>The default number of B frames is 2, but for most streams, the optimal number of B frames is 1. This provides the best tradeoffs for both video quality and objective quality use cases. The number of B frames can be adjusted according to the amount of motion in the video content. Generally, more B-frames helps compression, but hurts very high motion scenes. Xilinx recommends the following B frames settings:</p>
<ul class="simple">
<li><p>0 for gaming clips with fast motion, camera pan/rotation scenes</p></li>
<li><p>2 for static or slow moving scenes, talking heads, or video conferencing type of content</p></li>
<li><p>1 for all medium motion and all other content</p></li>
</ul>
<p>To set the number of B frames:</p>
<ul class="simple">
<li><p>When using FFmpeg, use the <a class="reference internal" href="using_ffmpeg.html#cmdoption-bf"><code class="xref std std-option docutils literal notranslate"><span class="pre">-bf</span></code></a> option</p></li>
<li><p>When using GStreamer, use the <a class="reference internal" href="using_gstreamer.html#cmdoption-arg-b-frames"><code class="xref std std-option docutils literal notranslate"><span class="pre">b-frames</span></code></a> option</p></li>
</ul>
<p>The number of B frames can also be adjusted as noted in <a class="reference internal" href="#dyn-parameters"><span class="std std-ref">Dynamic Encoder Parameters</span></a>, or dynamically, <a class="reference internal" href="#dynamic-gop"><span class="std std-ref">Dynamic GOP</span></a>.</p>
</section>
<section id="lookahead">
<span id="tuning-lookahead"></span><h2><a class="toc-backref" href="#id6" role="doc-backlink">Lookahead</a><a class="headerlink" href="#lookahead" title="Link to this heading">¶</a></h2>
<p>Lookahead is used to improve the accuracy of rate control by enabling the encoder to buffer a specified number of frames (using the parameter). Spatial and temporal complexity measures are computed for these frames. The rate control uses these measures to distribute more bits to frames which are hard to encode, and less bits to frames which are easy to encode. This redistribution results in better video quality. For spatial and temporal <a class="reference internal" href="#tuning-aq"><span class="std std-ref">adaptive quantization</span></a> to take effect, the lookahead depth must be set to at least 1. When latency is tolerable in applications, Xilinx recommends using the maximum lookahead depth to get optimum video quality.</p>
<p>The maximum lookahead value allowed is 1/3 of the stream frame rate. Therefore, the lookhead depth can be set up to 20 for streams with 60fps, and up to 10 for streams with 30fps.</p>
<p>To enable lookahead:</p>
<ul class="simple">
<li><p>When using FFmpeg, use the <a class="reference internal" href="using_ffmpeg.html#cmdoption-lookahead_depth"><code class="xref std std-option docutils literal notranslate"><span class="pre">-lookahead_depth</span></code></a> option</p></li>
<li><p>When using GStreamer, use the <a class="reference internal" href="using_gstreamer.html#cmdoption-arg-lookahead-depth"><code class="xref std std-option docutils literal notranslate"><span class="pre">lookahead-depth</span></code></a> option</p></li>
</ul>
</section>
<section id="adaptive-quantization">
<span id="tuning-aq"></span><h2><a class="toc-backref" href="#id7" role="doc-backlink">Adaptive Quantization</a><a class="headerlink" href="#adaptive-quantization" title="Link to this heading">¶</a></h2>
<p>This feature improves the video qualitity by changing the quantization parameter (QP) within a frame. The QP for each frame is determined by the rate control, and adaptive quantization (AQ) adjusts QP on top of that for different regions within a frame. It exploits the fact that the human eye is more sensitive to certain regions of a frame and redistributes more bits to those regions. The Xilinx video encoders support two types of AQ: Spatial Adaptive Quantization and Temporal Adaptive Quantization.</p>
<p>Adaptive Quantization is enabled by setting <a class="reference internal" href="using_ffmpeg.html#cmdoption-qp-mode"><code class="xref std std-option docutils literal notranslate"><span class="pre">-qp-mode</span></code></a> to <code class="docutils literal notranslate"><span class="pre">relative-load</span></code> or <code class="docutils literal notranslate"><span class="pre">auto</span></code> (default) and when <a class="reference internal" href="using_ffmpeg.html#cmdoption-lookahead_depth"><code class="xref std std-option docutils literal notranslate"><span class="pre">-lookahead_depth</span></code></a> &gt;= 1. When AQ is enabled, Spatial AQ and Temporal AQ can be individually controlled as described in the following sections.</p>
<p>Adaptive Quantization is disabled by setting <a class="reference internal" href="using_ffmpeg.html#cmdoption-qp-mode"><code class="xref std std-option docutils literal notranslate"><span class="pre">-qp-mode</span></code></a> to <code class="docutils literal notranslate"><span class="pre">uniform</span></code>. In this case, all CU’s within the frame are quantized using the same QP.</p>
<p class="rubric">Spatial Adaptive Quantization</p>
<p>Spatial AQ adjusts the QP within a frame based on the spatial characteristics. The human eye is more sensitive to regions which are flat and have low texture than regions which have lots of detail and texture. Spatial AQ exploits this and provides more bits to the low texture and flat regions at the expense of high texture regions. This redistribution of bits to visually perceptible regions of the frame brings about visual improvement. Although spatial AQ improves video qualitity, it hurts objective metrics and causes a drop in PSNR and VMAF. It is recommended to turn this feature off when performing PSNR/VMAF based evaluation.</p>
<p>The spatial AQ algorithm can be controlled using the spatial AQ gain option. The range of this option is from 0 to 100 and indicates the strength of the redistribution of data within the frame as a percentage. The default gain is 50.</p>
<p>To control spatial AQ:</p>
<ul class="simple">
<li><p>When using FFmpeg, use the <a class="reference internal" href="using_ffmpeg.html#cmdoption-spatial-aq"><code class="xref std std-option docutils literal notranslate"><span class="pre">-spatial-aq</span></code></a> option to enable or disable spatial AQ, and use the <a class="reference internal" href="using_ffmpeg.html#cmdoption-spatial-aq-gain"><code class="xref std std-option docutils literal notranslate"><span class="pre">-spatial-aq-gain</span></code></a> option to set the gain</p></li>
<li><p>When using GStreamer, use the <a class="reference internal" href="using_gstreamer.html#cmdoption-arg-spatial-aq"><code class="xref std std-option docutils literal notranslate"><span class="pre">spatial-aq</span></code></a> option to enable or disable spatial AQ, and use the <a class="reference internal" href="using_gstreamer.html#cmdoption-arg-spatial-aq-gain"><code class="xref std std-option docutils literal notranslate"><span class="pre">spatial-aq-gain</span></code></a> option to set the gain</p></li>
</ul>
<p>Spatial quantization can also be adjusted dynamically. Consult the <a class="reference internal" href="#dyn-parameters"><span class="std std-ref">Dynamic Encoder Parameters</span></a> section for more details on how to change this option during runtime.</p>
<p class="rubric">Temporal Adaptive Quantization</p>
<p>Temporal AQ adjusts the QP based on the temporal characteristics of the sequence. It utilizes the lookahead frames to capture the temporal characteristics where static/low motion or background is differentiated with high motion regions. The high motion regions are not very sensitive to the human eye as compared with low motion regions. Temporal AQ exploits this fact and redistributes more bits to static or low motion regions.</p>
<p>To control temporal AQ:</p>
<ul class="simple">
<li><p>When using FFmpeg, use the <a class="reference internal" href="using_ffmpeg.html#cmdoption-temporal-aq"><code class="xref std std-option docutils literal notranslate"><span class="pre">-temporal-aq</span></code></a> option to enable or disable temporal AQ</p></li>
<li><p>When using GStreamer, use the <a class="reference internal" href="using_gstreamer.html#cmdoption-arg-temporal-aq"><code class="xref std std-option docutils literal notranslate"><span class="pre">temporal-aq</span></code></a> option to enable or disable temporal AQ</p></li>
</ul>
<p>Temporal quantization can also be adjusted dynamically. Consult the <a class="reference internal" href="#dyn-parameters"><span class="std std-ref">Dynamic Encoder Parameters</span></a> section for more details on how to change this option during runtime.</p>
</section>
<section id="scaling-list">
<span id="tuning-scaling-list"></span><h2><a class="toc-backref" href="#id8" role="doc-backlink">Scaling List</a><a class="headerlink" href="#scaling-list" title="Link to this heading">¶</a></h2>
<p>Scaling list offers a mechanism to scale the transform coefficients by specifying scaling matrices. This influences the quality of encoded video. There are two options to specify the scaling lists mode: flat (0) and default (1).</p>
<p>For subjective video quality, the scaling list mode must be set to default. The default scaling mode gives more importance to low-frequency coefficients and less importance to high-frequency coefficients.</p>
<p>To improve the objective numbers (such as PSNR and VMAF), the scaling mode must be set to flat, where all the coefficients are scaled equally.</p>
<p>To control the scaling list mode:</p>
<ul class="simple">
<li><p>When using FFmpeg, use the <a class="reference internal" href="using_ffmpeg.html#cmdoption-scaling-list"><code class="xref std std-option docutils literal notranslate"><span class="pre">-scaling-list</span></code></a> option (0 = flat, 1 = default)</p></li>
<li><p>When using GStreamer, use the <a class="reference internal" href="using_gstreamer.html#cmdoption-arg-scaling-list"><code class="xref std std-option docutils literal notranslate"><span class="pre">scaling-list</span></code></a> option (0 = flat, 1 = default)</p></li>
</ul>
</section>
<section id="dynamic-encoder-parameters">
<span id="dyn-parameters"></span><h2><a class="toc-backref" href="#id9" role="doc-backlink">Dynamic Encoder Parameters</a><a class="headerlink" href="#dynamic-encoder-parameters" title="Link to this heading">¶</a></h2>
<p>Dynamic parameters are parameters which can be changed during runtime. This is useful to optimize video quality and compression rate for different segments of the video. This capability is supported through FFmpeg, GStreamer and the Video SDK C APIs.</p>
<p>The following encoder parameters can be dynamically modified:</p>
<ul class="simple">
<li><p>Number of B frames (0 to 4)</p></li>
<li><p>Bitrate (1000 to INT_MAX)</p></li>
<li><p>Temporal AQ mode (0 to 1)</p></li>
<li><p>Spatial AQ mode (0 to 1)</p></li>
<li><p>Spatial AQ gain (0 to 100)</p></li>
<li><p>Min/Max QP (1-51)</p></li>
</ul>
<p>When using FFmpeg or GStreamer, the encoder parameters which should be changed are specified in a configuration file as key-value pairs. This means that these key-value pairs must be known ahead of time. While this can used for file-based processing, this method is primarily intended as a testing mechanism.</p>
<p>When using the C APIs, the dynamic encoder parameters are updated on a frame-by-frame basis using side data. With this approach the top-level application can analyze the incoming frames, determine how to adjust the encoder parameters and update them before encoding the frame. This is primary intended use case for this capability.</p>
<p class="rubric">Dynamic Parameters Considerations</p>
<ul class="simple">
<li><p>Recommended settings for dynamic B frames are:</p>
<ul>
<li><p>0 for gaming clips with fast motion, camera pan/rotation scenes</p></li>
<li><p>2 for static or slow moving scenes, talking heads, or video conferencing type of content</p></li>
<li><p>1 for all medium motion and all other content</p></li>
</ul>
</li>
<li><p>B frames changes do not happen at the exact frame number specified. Instead, the change comes into effect one or two frames from the actual frame number specified in the config file.</p></li>
<li><p>The maximum value for the number of B frames is the value configured at initilization</p></li>
<li><p>In low latency mode, a dynamic bitrate changes is reflected after 1 or 2 GOPs. In normal latency mode, a bitrate change occurs within the next second.</p></li>
<li><p>The configuration files for dynamic parameters must comply with the format specified above. Ill-formed files may result in unexpected behavior.</p></li>
</ul>
<p class="rubric">FFmpeg</p>
<p>Encoder parameters which should be changed dynamically are specified as key-value pairs in a configuration file. This configuration file is provided to FFmpeg using the <a class="reference internal" href="using_ffmpeg.html#cmdoption-expert-options"><code class="xref std std-option docutils literal notranslate"><span class="pre">-expert-options</span></code></a> encoder switch with the <code class="docutils literal notranslate"><span class="pre">dynamic-params=&lt;file&gt;</span></code> option.</p>
<p>The <a class="reference internal" href="using_ffmpeg.html#cmdoption-expert-options"><code class="xref std std-option docutils literal notranslate"><span class="pre">-expert-options</span></code></a> option is specific to an encoded output. For use cases with multiple encoded outputs (such as ABR ladders), each output can have its own <a class="reference internal" href="using_ffmpeg.html#cmdoption-expert-options"><code class="xref std std-option docutils literal notranslate"><span class="pre">-expert-options</span></code></a> option and associated configuration file.</p>
<p>The configuration file should contain one line for each frame where one or more parameters are changed. Each line should start with the frame number followed by a list of key-value pairs for all the modified parameters:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>&lt;frameNumberN1&gt;:&lt;key1&gt;=&lt;value1&gt;
&lt;frameNumberN2&gt;:&lt;key2&gt;=&lt;value2&gt;,&lt;key3&gt;=&lt;value3&gt;
</pre></div>
</div>
<p>Below is a table listing the parameters which can be changed at runtime, the corresponding key and valid values.</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Dynamic Parameter</p></th>
<th class="head"><p>Key</p></th>
<th class="head"><p>Valid Values</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>Number of B frames</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">NumB=&lt;int&gt;</span></code></p></td>
<td><p>0 to 4</p></td>
</tr>
<tr class="row-odd"><td><p>Bitrate (in bits per second)</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">BR=&lt;int&gt;</span></code></p></td>
<td><p>1000 to INT_MAX</p></td>
</tr>
<tr class="row-even"><td><p>Temporal AQ mode</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">tAQ=&lt;int&gt;</span></code></p></td>
<td><p>0 to 1</p></td>
</tr>
<tr class="row-odd"><td><p>Spatial AQ mode</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">sAQ=&lt;int&gt;</span></code></p></td>
<td><p>0 to 1</p></td>
</tr>
<tr class="row-even"><td><p>Spatial AQ gain</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">sAQGain=&lt;int&gt;</span></code></p></td>
<td><p>0 to 100</p></td>
</tr>
<tr class="row-odd"><td><p>Min/Max QP</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">MinQP=&lt;int&gt;,MaxQP=&lt;int&gt;</span></code></p></td>
<td><p>1 to 51</p></td>
</tr>
</tbody>
</table>
<p>Sample FFmpeg encode command:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>ffmpeg -c:v mpsoc_vcu_hevc -i input.h265 -c:v mpsoc_vcu_hevc -b:v 2.5M -lookahead_depth 10 -expert-options dynamic-params=dynparams.txt -y output.h265
</pre></div>
</div>
<p>Sample configuration file for dynamic parameters:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>300:NumB=1
600:BR=6000000
1200:sAQ=1,sAQGain=50
1800:tAQ=1
2400:NumB=0,BR=10000000,sAQ=0,sAQGain=50,tAQ=0
5000:MinQP=30,MaxQP=35
</pre></div>
</div>
<p class="rubric">GStreamer</p>
<p>Encoder parameters which should be changed dynamically are specified as key-value pairs in a JSON configuration file, as follows:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>&quot;dynamic_params&quot; :[
{
  &quot;frame&quot; : 600,
  &quot;b-frames&quot; : 2,
  &quot;bitrate&quot; : 6000,
  &quot;temporal-aq&quot; : false,
  &quot;spatial-aq&quot; : true,
  &quot;spatial-aq-gain&quot; : 50
  &quot;min-qp&quot; : 25,
  &quot;max-qp&quot; : 35
},
{
  &quot;frame&quot; : 1500,
  &quot;b-frames&quot; : 0,
  &quot;bitrate&quot; : 3000
  &quot;temporal-aq&quot; : true,
  &quot;spatial-aq&quot; : true,
  &quot;spatial-aq-gain&quot; : 50,
  &quot;min-qp&quot; : 5,
  &quot;max-qp&quot; : 15
}
]
</pre></div>
</div>
<p>Refer to the <a class="reference internal" href="examples/gstreamer/xabrladder.html#gst-abrladder"><span class="std std-ref">GStreamer ABR Ladder Application</span></a> for a working example leveraging dynamic parameters with GStreamer. This
example includes a complete <a class="reference internal" href="examples/gstreamer/xabrladder.html#dynamic-params-json"><span class="std std-ref">JSON file</span></a> for configuring the dynamic parameters and a description of <a class="reference internal" href="examples/gstreamer/xabrladder.html#dynamic-params-test-example"><span class="std std-ref">command line  usage</span></a>.</p>
<p class="rubric">C APIs</p>
<p>Encoder parameters which should be changed dynamically must be specified in a data structure called <a class="reference internal" href="#c.XlnxDynParams" title="XlnxDynParams"><code class="xref c c-struct docutils literal notranslate"><span class="pre">XlnxDynParams</span></code></a> and defined as follows:</p>
<dl class="c struct">
<dt class="sig sig-object c" id="c.XlnxDynParams">
<span class="k"><span class="pre">struct</span></span><span class="w"> </span><span class="sig-name descname"><span class="n"><span class="pre">XlnxDynParams</span></span></span><a class="headerlink" href="#c.XlnxDynParams" title="Link to this definition">¶</a><br /></dt>
<dd></dd></dl>

<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>typedef struct XlnxLaDynParams {
    bool     is_spatial_gain_changed;
    uint32_t spatial_aq_gain;
    bool     is_temporal_mode_changed;
    bool     temporal_aq_mode;
    bool     is_spatial_mode_changed;
    bool     spatial_aq_mode;
} XlnxLaDynParams;

typedef struct XlnxEncDynParams {
    bool     is_bitrate_changed;
    uint32_t bit_rate;
    bool     is_bframes_changed;
    uint8_t  num_b_frames;
    bool     is_min_max_qp_changed;
    uint32_t min_qp;
    uint32_t max_qp;
} XlnxEncDynParams;

typedef struct XlnxDynParams {
    XlnxEncDynParams enc_dyn_param;
    XlnxLaDynParams  la_dyn_param;
} XlnxDynParams;
</pre></div>
</div>
<p>The <a class="reference internal" href="#c.XlnxDynParams" title="XlnxDynParams"><code class="xref c c-struct docutils literal notranslate"><span class="pre">XlnxDynParams</span></code></a> data structure is then passed along as side-data to the encoded frame using the <code class="xref c c-func docutils literal notranslate"><span class="pre">xma_frame_add_side_data()</span></code> API. The encoder plugin then takes care of updating the parameters automatically.</p>
<p>For of an example of how this can be implemented, refer to the <code class="xref c c-func docutils literal notranslate"><span class="pre">xlnx_enc_add_dyn_params()</span></code> function in the <a class="reference external" href="https://github.com/Xilinx/video-sdk-u30-examples/blob/main/examples/u30/xma/lib-dyn-enc-params/src/xlnx_enc_dyn_params.c">src/xlnx_enc_dyn_params.c</a> file of the shared library providing dynamic encoder paramater support.</p>
<p class="rubric">XMA Encoder and Transcoder Applications</p>
<p>The XMA Encoder and Transcoder sample applications also feature support for dynamically changing encoder parameters. These sample applications are developed using the Video SDK C APIs. Dynamic parameters are handled in the same way as for FFmpeg: they are specified in a configuration file following the same syntax as for FFmpeg, and the configuration file is passed to the application using the <code class="docutils literal notranslate"><span class="pre">-expert-options</span> <span class="pre">dynamic-params=&lt;file&gt;</span></code> option.</p>
<p>XMA H.264 Encode Example:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>u30_xma_encode -w 1920 -h 1080 -pix_fmt yuv420p -i input_1080.yuv -fps 60 -g 120 -periodicity-idr 120 -frames 600 -c:v mpsoc_vcu_h264 -expert-options dynamic-params=cmdfile.txt -lookahead-depth 20 -spatial-aq 1 -temporal-aq 1 -spatial-aq-gain 80 -o out1.264
</pre></div>
</div>
<p>XMA HEVC Encode Example:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>u30_xma_encode -w 1920 -h 1080 -pix_fmt yuv420p -i input_1080.yuv -fps 60 -g 120 -periodicity-idr 120 -frames 600 -c:v mpsoc_vcu_hevc -expert-options dynamic-params=cmdfile.txt -lookahead-depth 20 -spatial-aq 1 -temporal-aq 1 -spatial-aq-gain 80 -o out2.265
</pre></div>
</div>
<p>XMA ABR Transcode Example:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>u30_xma_transcode -c:v mpsoc_vcu_h264 -i sample.h264 -multiscale_xma -num-output 2 -out_1_width 1280 -out_1_height 720 -out_2_width 848 \
                  -c:v mpsoc_vcu_h264 -b:v 3000K -expert-options dynamic-params=cmdfile.txt -qp-mode 2 -lookahead-depth 16 -temporal-aq 1 -spatial-aq 1 -spatial-aq-gain 75 -o out_dp_test1.h264 \
                  -c:v mpsoc_vcu_h264 -b:v 4000K -expert-options dynamic-params=cmdfile.txt -qp-mode 2 -lookahead-depth 16 -temporal-aq 1 -spatial-aq 1 -spatial-aq-gain 75 -o out_dp_test2.h264
</pre></div>
</div>
</section>
<section id="dynamic-idr-frame-insertion">
<span id="dyn-idr-frame"></span><h2><a class="toc-backref" href="#id10" role="doc-backlink">Dynamic IDR Frame Insertion</a><a class="headerlink" href="#dynamic-idr-frame-insertion" title="Link to this heading">¶</a></h2>
<p>The dynamic IDR frame insertion feature allows encoding any incoming frame as IDR at runtime. This capability is supported through FFmpeg, GStreamer and the Video SDK C APIs.</p>
<p>Dynamic IDR frame insertion resets the GOP position. That is, if the stream is running with a GOP size of 120 (an IDR frame every 120 frames) and if an IDR frame is dynamically inserted at frame 50, the next IDR frame would be at frame 170 instead of 120.</p>
<p>To control dynamic IDR frame insertion:</p>
<ul class="simple">
<li><p>When using FFmpeg, use the <a class="reference internal" href="using_ffmpeg.html#cmdoption-force_key_frames"><code class="xref std std-option docutils literal notranslate"><span class="pre">-force_key_frames</span></code></a> option</p></li>
<li><p>When using GStreamer, use the <a class="reference internal" href="examples/gstreamer/xabrladder.html#cmdoption-forcekeyframe"><code class="xref std std-option docutils literal notranslate"><span class="pre">--forcekeyframe</span></code></a> option to <code class="docutils literal notranslate"><span class="pre">vvas_xabrladder</span></code> application</p></li>
<li><p>When using the C APIs, set the <code class="docutils literal notranslate"><span class="pre">is_idr</span></code> flag in the <a class="reference internal" href="c_apis.html#c.XmaFrame" title="XmaFrame"><code class="xref c c-struct docutils literal notranslate"><span class="pre">XmaFrame</span></code></a> data structure of frame to be encoded as IDR</p></li>
</ul>
<p class="rubric">FFmpeg</p>
<p>To control dynamic IDR frame insertion in FFmpeg, use the <a class="reference internal" href="using_ffmpeg.html#cmdoption-force_key_frames"><code class="xref std std-option docutils literal notranslate"><span class="pre">-force_key_frames</span></code></a> option. This option can take either a list of timestamps (time,[time…]) or an expression (expr:<em>expr</em>).</p>
<ul class="simple">
<li><p>When using timestamps, FFmpeg will round the specified times to the nearest output timestamp as per the encoder time base and force a keyframe at the first frame having timestamp equal or greater than the computed timestamp.</p></li>
<li><p>When using an expression, the string is interpreted like an expression and is evaluated for each frame. A key frame is forced in case the evaluation is non-zero.</p></li>
</ul>
<p>Example using timestamps - Forcing IDR frames at specific time intervals:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>ffmpeg -re -c:v mpsoc_vcu_hevc -i input.mp4 -c:v mpsoc_vcu_h264 –b:v 5M –force_key_frames 1,2,3,5,8,13,21 -f mp4 out.mp4
</pre></div>
</div>
<p>Example using expressions - Forcing an IDR frame every 5 seconds:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>ffmpeg -re -c:v mpsoc_vcu_hevc -i input.mp4 -c:v mpsoc_vcu_h264 –b:v 5M -force_key_frames expr:gte(t,n_forced*5) -f mp4 out.mp4
</pre></div>
</div>
<p>For more details on using timestamps or expressions, see -force_key_frames in FFmpeg documentation (<a class="reference external" href="https://ffmpeg.org/ffmpeg-all.html">https://ffmpeg.org/ffmpeg-all.html</a>).</p>
<p class="rubric">GStreamer</p>
<p>To control IDR frame insertion in GStreamer, use the <a class="reference internal" href="examples/gstreamer/xabrladder.html#cmdoption-forcekeyframe"><code class="xref std std-option docutils literal notranslate"><span class="pre">--forcekeyframe</span></code></a> option in <a class="reference internal" href="examples/gstreamer/xabrladder.html#gst-abrladder"><span class="std std-ref">vvas_xabrladder</span></a> application. This option takes IDR frame insertion frequency in number of frames.</p>
<p>Example to force an IDR frame every 30 frames:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>vvas_xabrladder --devidx 0 --lookahead_enable 0 --codectype 1 --forcekeyframe 30 --file &lt;path to input file&gt;
</pre></div>
</div>
<p class="rubric">C APIs</p>
<p>To encode an incoming frame as IDR, the application needs to set the <code class="docutils literal notranslate"><span class="pre">is_idr</span></code> flag in the <a class="reference internal" href="c_apis.html#c.XmaFrame" title="XmaFrame"><code class="xref c c-struct docutils literal notranslate"><span class="pre">XmaFrame</span></code></a> structure which is being sent to the lookahead module and then to the encoder:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>XmaFrame la_in_frame;

la_in_frame.is_idr = 1;
</pre></div>
</div>
<p>For a complete source code reference, refer to <code class="xref c c-func docutils literal notranslate"><span class="pre">xlnx_enc_set_if_idr_frame()</span></code> function in the <a class="reference external" href="https://github.com/Xilinx/video-sdk-u30-examples/blob/main/examples/u30/xma/transcoder/lib/src/xlnx_transcoder.c">transcoder/lib/src/xlnx_transcoder.c</a> file of the XMA transcoder application.</p>
<p class="rubric">XMA Encoder and Transcoder Applications</p>
<p>In the XMA encoder and transcoder applications, use the -force_key_frame command line option to set IDR frames at specific frame numbers:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>u30_xma_transcode -c:v mpsoc_vcu_h264 -i input.264 -c:v mpsoc_vcu_h264 -b:v 6000K -force_key_frame &quot;(200,300,250,200,180,400)&quot; -o out.264
</pre></div>
</div>
</section>
<section id="dynamic-gop">
<span id="id2"></span><h2><a class="toc-backref" href="#id11" role="doc-backlink">Dynamic GOP</a><a class="headerlink" href="#dynamic-gop" title="Link to this heading">¶</a></h2>
<p>The ability to change the composition of a GOP, in response to the content of a video, is of great benefit in video compression. U30 family of devices offer variable number of B frames, 0 to 2, in response to variations in motion vectors, within the lookahead buffer. Specifically, the inserted number of B frames is inversely proportional to variations in motion vector. Control parameter <a class="reference internal" href="using_ffmpeg.html#cmdoption-dynamic-gop"><code class="xref std std-option docutils literal notranslate"><span class="pre">-dynamic-gop</span></code></a> enables and disables this feature. Note that this parameter is not compatible with <a class="reference internal" href="using_ffmpeg.html#cmdoption-bf"><code class="xref std std-option docutils literal notranslate"><span class="pre">-bf</span></code></a> and requires a minimal lookahead depth of 5 frames.
Various examples illustrating the effect of these settings can be found here:</p>
<ul class="simple">
<li><p>When using FFmpeg, the <a class="reference internal" href="using_ffmpeg.html#cmdoption-dynamic-gop"><code class="xref std std-option docutils literal notranslate"><span class="pre">-dynamic-gop</span></code></a> option can be set to 1 to enable this feature.</p></li>
<li><p>When using GStreamer, the <a class="reference internal" href="using_gstreamer.html#cmdoption-arg-dynamic-gop"><code class="xref std std-option docutils literal notranslate"><span class="pre">dynamic-gop</span></code></a> option can be set to 1 to enable this feature. This parameter is not compatible with <a class="reference internal" href="using_gstreamer.html#cmdoption-arg-b-frames"><code class="xref std std-option docutils literal notranslate"><span class="pre">b-frames</span></code></a> and requires a minimal lookahead depth of 5 frames.</p></li>
<li><p><a class="reference internal" href="examples/ffmpeg/tutorials.html"><span class="doc">FFmpeg quality analysis examples</span></a>.</p></li>
</ul>
</section>
<section id="objective-metrics-versus-subjective-quality">
<span id="objective-vs-subjective"></span><h2><a class="toc-backref" href="#id12" role="doc-backlink">Objective Metrics versus Subjective Quality</a><a class="headerlink" href="#objective-metrics-versus-subjective-quality" title="Link to this heading">¶</a></h2>
<p>Encoder settings can be used to optimize for objective quality (metrics such as PSNR, SSIM or VMAF) or subjective quality (visual appeal). This section summarizes recommended settings for these two goals.</p>
<p class="rubric">Optimizing for Objective Metrics</p>
<p>To optimize for objective metrics, Adaptive Quantization should be disabled and a flat scaling list should be used. Doing so provides equal importance to all the blocks in the frame: the same quantization parameters and transform coefficients are used for all of them.</p>
<ul class="simple">
<li><p>When using FFmpeg, the <a class="reference internal" href="using_ffmpeg.html#cmdoption-tune-metrics"><code class="xref std std-option docutils literal notranslate"><span class="pre">-tune-metrics</span></code></a> option can be set to 1 to automatically disable AQ and use a flat scaling list.</p></li>
<li><p>When using GStreamer, the <a class="reference internal" href="using_gstreamer.html#cmdoption-arg-tune-metrics"><code class="xref std std-option docutils literal notranslate"><span class="pre">tune-metrics</span></code></a> option can be set to 1 to automatically disable AQ and use a flat scaling list.</p></li>
</ul>
<p class="rubric">Optimizing for Subjective Quality</p>
<p>To optimize for subjective quality, Adaptive Quantization should be enabled and the default scaling list should be used.</p>
<p>Adaptive Quantization (AQ) exploits the fact that the human eye is more sensitive to certain regions of a frame. This method drops information from high-frequency locations and keeps more information in low-frequency locations in a frame. The result appears more visually appealing. The Spatial AQ Gain parameter controls the strength of the redistribution of data within the frame. Setting too high a value may have a consequence of blurring edges. Experimentation across your clips is recommended if you wish to tune this parameter.</p>
<p>The default scaling list is used to scale up low-frequency data in the stream such that when it is quantized down during the encoding process, detail is retained.</p>
<p>For more details about <a class="reference internal" href="#tuning-aq"><span class="std std-ref">Adaptive Quantization</span></a> and the <a class="reference internal" href="#tuning-scaling-list"><span class="std std-ref">Scaling List</span></a>, refer to the corresponding sections.</p>
</section>
</section>


           </div>
          </div>
          
                  <style>
                        .footer {
                        position: fixed;
                        left: 0;
                        bottom: 0;
                        width: 100%;
                        }
                  </style>
				  
				  <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="using_gstreamer.html" class="btn btn-neutral float-left" title="Using GStreamer" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="tuning_pipeline_latency.html" class="btn btn-neutral float-right" title="Tuning Transcode Latency" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2020-2023, Advanced Micro Devices, Inc.
      <span class="lastupdated">Last updated on October 16, 2024.
      </span></p>
  </div>



										<div class="aem-Grid aem-Grid--16">
											<div class="aem-GridColumn aem-GridColumn--xxxlarge--none aem-GridColumn--xsmall--16 aem-GridColumn--offset--xsmall--0 aem-GridColumn--xlarge--none aem-GridColumn--xxlarge--none aem-GridColumn--default--none aem-GridColumn--offset--large--1 aem-GridColumn--xlarge--12 aem-GridColumn--offset--default--0 aem-GridColumn--xxlarge--10 aem-GridColumn--offset--xlarge--2 aem-GridColumn--offset--xxlarge--3 aem-GridColumn--offset--xxxlarge--4 aem-GridColumn--xsmall--none aem-GridColumn--large--none aem-GridColumn aem-GridColumn--large--14 aem-GridColumn--xxxlarge--8 aem-GridColumn--default--16">
												<div class="container-fluid sub-footer">

													                    <div class="row">
                        <div class="col-xs-24">
                          <p><a target="_blank" href="https://www.amd.com/en/corporate/copyright">Terms and Conditions</a> | <a target="_blank" href="https://www.amd.com/en/corporate/privacy">Privacy</a> | <a target="_blank" href="https://www.amd.com/en/corporate/cookies">Cookie Policy</a> | <a target="_blank" href="https://www.amd.com/en/corporate/trademarks">Trademarks</a> | <a target="_blank" href="https://www.amd.com/system/files/documents/statement-human-trafficking-forced-labor.pdf">Statement on Forced Labor</a> | <a target="_blank" href="https://www.amd.com/en/corporate/competition">Fair and Open Competition</a> | <a target="_blank" href="https://www.amd.com/system/files/documents/amd-uk-tax-strategy.pdf">UK Tax Strategy</a> | <a target="_blank" href="https://docs.xilinx.com/v/u/9x6YvZKuWyhJId7y7RQQKA">Inclusive Terminology</a> | <a href="#cookiessettings" class="ot-sdk-show-settings">Cookies Settings</a></p>
                        </div>
                    </div>
												</div>
											</div>
										</div>
										
</br>


  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>
 <script type="text/javascript">
    $(document).ready(function() {
        $(".toggle > *").hide();
        $(".toggle .header").show();
        $(".toggle .header").click(function() {
            $(this).parent().children().not(".header").toggle(400);
            $(this).parent().children(".header").toggleClass("open");
        })
    });
</script>


</body>
</html>